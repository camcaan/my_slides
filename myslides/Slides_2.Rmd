---
title: "Multi-state modelling for dementia care path"
# subtitle: ""
author: "Kamran Khan"
institute: "Institute of Health Informatics"
date: ""
output:
  xaringan::moon_reader:
    css:
      - default
      - css/nhsr.css
      - css/nhsr-fonts.css
    lib_dir: libs   #creates directory for libraries
    seal: false      # false : custom title slide
    nature:
      highlightStyle: googlecode   #highlighting syntax for code 
      highlightLines: true         # true: enables code line highlighting
      highlightLanguage: ["r"]     # language to highlight
      countIncrementalSlides: false  # false: disables counting of incremental slides
      ratio: "16:9"                  # 4:3 for standard size
    includes:
      after_body: css/insert-logo.html   # add logo
---

```{r setup, include = FALSE}
library(knitr)
library(tidyverse)
library(nhsrtheme)
library(xaringanExtra)
library(survival)
xaringanExtra::use_panelset()
# set default options
opts_chunk$set(echo = FALSE,
               fig.width = 7.252,
               fig.height = 4,
               dpi = 300)
xaringanExtra::use_tile_view()
use_share_again()
xaringanExtra::style_share_again(share_buttons = c("twitter", "linkedin", "pocket"))


# 
# uncomment the following lines if you want to use the NHS-R theme colours by default
# scale_fill_continuous <- partial(scale_fill_nhs, discrete = FALSE)
# scale_fill_discrete <- partial(scale_fill_nhs, discrete = TRUE)
# scale_colour_continuous <- partial(scale_colour_nhs, discrete = FALSE)
# scale_colour_discrete <- partial(scale_colour_nhs, discrete = TRUE)
```

class: title-slide, left, bottom

# `r rmarkdown::metadata$title`
----
## **`r rmarkdown::metadata$subtitle`**
### `r rmarkdown::metadata$author`
### `r rmarkdown::metadata$date`

---
class: inverse, middle, center

# Aim of the study

---
class: middle

# The aim is to jointly model disease progression, mortality, and their relationship with patientâ€™s characteristics to understand the prognosis of dementia patients.

---


class: inverse, middle, center

# Study Design

---
class: middle

# A retrospective cohort design, describing the rates of repeated hospital admissions, transition to an institution and death and the clinical factors affecting the rates of these events.

---

class: inverse, middle, center

# What Modelling approach and Why ?

---
class: middle, center

* **A multi-state modelling approach because standard time-to-event analysis such as Cox PH only takes into account time to first event and ignore the subsequent events**.

--

* **Various counting process or gap time models also has the limitation of treating terminal event such as death as censored, implying that the patients are still at risk of experiencing further recurrent events.**

--

* **To overcome these a MSM is recommended - it models the terminal event as an absorbing state, since no recurrent events can occur after this.**



???
This model represent subsequent periods spent in and out of hospital.how the risk of death and further hospitalisation changes through time.

---
# Structure of the first model

--

<img src="img/firstModel.png"  width="90%">

??? 


This model represent subsequent periods spent in and out of hospital. This will allow us to model how the risk of death and further hospitalisation changes through time.

---


# Structure of the second model


<img src="img/SecondModel.png"  width="90%">

???
This model concern both hospitalisations and institutionalisation and will evaluate the factors associated with transition into an institution with respect to repeated hospitalisation or death.
---

class: inverse, middle, center

# Multi-state data

---
class: middle



* **In ordinary survival data we have : time , status**


--


*  **In multi-state : time1, time2 and the status is a multi-level factor variable**


???
So, instead of covariates changing from line to line as in ordinary survival analysis, in MSM the status variable changes; it contains the state that was entered at time2.
--

* **We will need an id variable to indicate which rows of the data frame belong to each subject.**
--

---
# European Blood and Marrow Transplant data

* `prtime` - time in days from transplant to platelet recovery or last follow-up
* `rfstime` - time in days from transplant to relapse or death or last follow-up
* `dissub` - Disease subclassification : levels = AML, ALL, CML
* `drmatch` - Donor recipient 
* `tcd` - T cell depletion
```{r}
library(mstate)
data("ebmt3")
library(survival)



ebmt3 %>% 
head() %>% 
  knitr::kable(format = "html")

```




---
class: center, middle
```{r, echo = TRUE}
states <- c("Transplant", "Platelet recovery", 
            "Relapse or death")
tmat <- matrix(0, 3,3, dimnames=list(states, states))
tmat[1,2] <- tmat[1,3] <- tmat[2,3] <- 1 # arrows
statefig(cbind((1:3)/4, c(1,3,1)/4), tmat)
```

---
class: inverse, middle, center


# Multi-state model using `ebmt3` data

---
# Create the analysis data
```{r statefig2, echo=TRUE}

edata <- tmerge(ebmt3[, c("id", "age", "dissub", "drmatch", "tcd")],ebmt3, id = id, 
                rstat = event(rfstime, rfsstat),
                pstat = event(prtime, prstat),
                priorpr = tdc(prtime))

print(edata[15:20, -(3:5)])


```

---
class: inverse, middle, center

# Creating the factor outcome

---
### Make the event variable a factor and run `survcheck()`###

```{r echo = TRUE}
edata$event <- with(edata, factor(pstat + 2*rstat, 0:2,
                                  labels = c("censor", "PR", "RelDeath")))
levels(edata$drmatch) <- c("Match", "Mismatch")
survcheck(Surv(tstart, tstop, event) ~ 1, data = edata, id = id)

```
---
class: inverse, middle, center

 ## Aalen-Johansen P(t) curves## 
---
 .panelset[
.panel[.panel-name[fit 1]

```{r, echo= TRUE}
surv1 <- survfit(Surv(tstart, tstop, event) ~ 1, edata, id = id)
surv1$transitions
```

.panel[.panel-name[plot 1]

```{r}
plot(surv1, col = 1:2, xscale = 365.25 , lwd = 2,
     xlab = "Years since transplant" , ylab = "Fraction in state")
legend(1000, .2, c("Platelet recovery", "Death or Relapse"),
       lty = 1, col = 1:2, lwd = 2, bty = 'n')
```

]
]
]

---
class: inverse, middle, center

 ## Transition-specific covariate effect estimation## 
 
---
.panelset[
.panel[.panel-name[coxph]

```{r,echo=TRUE}
efit1 <- coxph(Surv(tstart, tstop, event) ~ dissub + age + drmatch + tcd, 
               id = id , data = edata, ties = "breslow")

```
.panel[.panel-name[coefficients]
```{r}

print(efit1, digits = 2)
```

.panel[.panel-name[Baseline Hazard]
```{r, echo=FALSE}
# Now draw the figure for baseline hazards
# a dataset containing the 'reference' categories 

rdata <- data.frame(dissub = "AML", age = "<=20" , "drmatch" = "Match" , tcd = "No TCD" )

esurv1 <- survfit(efit1, newdata = rdata)
plot(esurv1, cumhaz = TRUE, lty = 1:3, xscale = 365.25, xmax = 7*365.25,
xlab = "Years since transplant", ylab = "Cumulative hazard")
legend(365, .8, c("Transplant to platelet recovery (1:2)",
                  "Transplant to death (1:3)",
                  "Platelet recovery to death (2:3)"), lty = 1:3, bty = 'n')
```


]
]
]
]
---
class: inverse, middle, center

 ## Proportional hazard model## 
 
---

.panelset[
.panel[.panel-name[proportional Hazard]
```{r, echo=TRUE}
efit2 <- coxph(list(Surv(tstart, tstop, event) ~ dissub + age + drmatch + tcd,
               0:state("RelDeath") ~ 1 / common,
               "PR":"RelDeath" ~ priorpr),
               id = id, data = edata, ties = "breslow")

```




.panel[.panel-name[Coefficients]
```{r}
print(coef(efit2, type = "matrix"), digits = 2)
```

]
]
]

???
In this model the transition hazards into relapse or death(transitions 2 and 3) are assumed to be proportional.For this purpose tranistion 1 blong to one stratum and transition 2 and 3 belong to another stratum.the baseline hazard is shared for transition 1 to 3 and transition 2 to 3 because they transition into same sate (state 3).The fit below adds this constraint by stating that two transitions have a common intercept (1) and adding a coefficient for prior plasma recovery to the two transitions.Now every data row at risk for a 2:3 transition has priorpr = 1 and the rows for a 1:3 all have priorpr = 0

---
class: inverse, middle, center

 ## Prediction## 
 
---
.panelset[
.panel[.panel-name[Prediction model]
```{r, echo=TRUE}
edummy <- expand.grid(age = "<=20", dissub = "AML", drmatch = "Mismatch",
                      tcd = c("No TCD", "TCD"), priorpr = 1)

ecurve2 <- survfit(efit2, newdata = edummy)
```

.panel[.panel-name[Predition probabilities plot]
```{r}
plot(ecurve2, col=c(1,1,3,3,5,5), lty=1:2, lwd=2, xscale=365.25,
     noplot=NULL, 
     xlab="Years since transplant", ylab="Predicted probabilities")
legend(700, .9, c("Currently alive in remission, no PR", "Currently in PR",
                  "Relapse or death"), col= c(1,3,5), lwd=2, bty='n')
text(700, .95, "Solid= No TCD, dashed = TCD", adj=0)
```

]
]
]

???
we will now predict the future state of a patient, using as our reference set two subjects who are 
<= 20 years old, gender matched, AML, with and without T-cell depletion.
we will use the fit from the proportional hazard model for the transitions to Relapse/Death and 
a separate baseline hazard for the PR transition
---
class: inverse, middle, center

 ## Data structure for the first model## 
 
---
<!-- ![](img/DataStr_ScreenShot.png) -->

<img src="img/DataStr_ScreenShot.png"  width="90%">
